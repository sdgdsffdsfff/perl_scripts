AUTHOR = """
uril@redhat.com (Uri Lublin)
drusso@redhat.com (Dror Russo)
mgoldish@redhat.com (Michael Goldish)
dhuff@redhat.com (David Huff)
aeromenk@redhat.com (Alexey Eromenko)
mburns@redhat.com (Mike Burns)
"""
TIME = 'MEDIUM'
NAME = 'KVM test'
TEST_TYPE = 'client'
TEST_CLASS = 'Virtualization'
TEST_CATEGORY = 'Functional'

DOC = """
Executes the KVM test framework on a given host. This module is separated in
minor functions, that execute different tests for doing Quality Assurance on
KVM (both kernelspace and userspace) code.

For online docs, please refer to http://www.linux-kvm.org/page/KVM-Autotest
"""

import sys, os, logging
# Add the KVM tests dir to the python path
kvm_test_dir = os.path.join(os.environ['AUTODIR'],'tests/kvm')
sys.path.append(kvm_test_dir)
# Now we can import modules inside the KVM tests dir
import kvm_utils, kvm_config

# set English environment (command output might be localized, need to be safe)
os.environ['LANG'] = 'en_US.UTF-8'

build_cfg_path = os.path.join(kvm_test_dir, "build.cfg")
build_cfg = kvm_config.config(build_cfg_path)
# Make any desired changes to the build configuration here. For example:
#build_cfg.parse_string("""
#release_tag = 84
#""")
if not kvm_utils.run_tests(build_cfg.get_list(), job):
    logging.error("KVM build step failed, exiting.")
    sys.exit(1)

tests_cfg_path = os.path.join(kvm_test_dir, "tests.cfg")
tests_cfg = kvm_config.config(tests_cfg_path)
# Make any desired changes to the test configuration here. For example:
#tests_cfg.parse_string("""
#display = sdl
#install|setup: timeout_multiplier = 3
#""")

pools_cfg_path = os.path.join(kvm_test_dir, "address_pools.cfg")
tests_cfg.parse_file(pools_cfg_path)
hostname = os.uname()[1].split(".")[0]
if tests_cfg.filter("^" + hostname):
    tests_cfg.parse_string("only ^%s" % hostname)
else:
    tests_cfg.parse_string("only ^default_host")

# Run the tests
kvm_utils.run_tests(tests_cfg.get_list(), job)

# Generate a nice HTML report inside the job's results dir
kvm_utils.create_report(kvm_test_dir, job.resultdir)

